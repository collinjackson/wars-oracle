     1|<!DOCTYPE html>
     2|<html lang="en">
     3|<head>
     4|    <meta charset="UTF-8">
     5|    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     6|    <title>Wars Oracle Generator</title>
     7|    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”®</text></svg>">
     8|    <style>
     9|        body { font-family: system-ui, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #1a1a1a; color: #eee; }
    10|        input, button, select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #444; background: #333; color: white; }
    11|        button { background: #0070f3; cursor: pointer; font-weight: bold; border: none; transition: background 0.2s; }
    12|        button:hover { background: #005bb5; }
    13|        button.secondary { background: transparent; border: 1px solid #555; color: #aaa; width: auto; padding: 5px 15px; font-size: 0.9em; }
    14|        button.secondary:hover { background: #333; color: #fff; }
    15|        textarea { width: 100%; height: 300px; background: #222; color: #0f0; font-family: monospace; border: 1px solid #444; padding: 10px; margin-top: 10px; resize: vertical; }
    16|        .hidden { display: none; }
    17|        label { display: block; margin-bottom: 5px; font-weight: bold; color: #aaa; }
    18|        .success-box { background: #2a2a2a; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #444; text-align: center; }
    19|        .step-number { display: inline-block; background: #444; color: #fff; width: 24px; height: 24px; border-radius: 12px; text-align: center; line-height: 24px; margin-right: 8px; font-size: 0.9em; }
    20|    </style>
    21|</head>
    22|<body>
    23|    <h1>Wars Oracle ðŸ”®</h1>
    24|    <p>Generate a strategic briefing for AI analysis.</p>
    25|    
    26|    <label for="gameId">AWBW Game Link or ID</label>
    27|    <input type="text" id="gameId" placeholder="Paste link or ID (e.g. 1548776)" oninput="handleInput()">
    28|    
    29|    <label for="username">Your Identity</label>
    30|    <select id="username" onchange="saveState()">
    31|        <option value="">-- Select Player --</option>
    32|        <option value="" disabled>Enter Game ID first...</option>
    33|    </select>
    34|    
    35|    <button onclick="generateContext()" id="generateBtn">Generate Briefing</button>
    36|    
    37|    <div id="result" class="hidden success-box">
    38|        <h2 style="margin-top: 0; color: #fff;">âœ… Briefing Ready</h2>
    39|        
    40|        <div style="margin: 20px 0;">
    41|            <button onclick="copyToClipboard()" id="copyBtn" style="font-size: 1.1em; padding: 15px; background: #10a37f;">
    42|                ðŸ“‹ Copy Prompt to Clipboard
    43|            </button>
    44|            <p style="color: #aaa; margin-top: 10px; font-size: 0.95em;">
    45|                <span class="step-number">1</span> Click above to copy<br>
    46|                <span class="step-number" style="margin-top: 8px;">2</span> Paste into ChatGPT, Claude, or Gemini
    47|            </p>
    48|        </div>
    49|
    50|        <div style="border-top: 1px solid #444; padding-top: 15px; margin-top: 15px;">
    51|            <button onclick="togglePrompt()" class="secondary">Show/Hide Full Text</button>
    52|            <textarea id="output" readonly class="hidden"></textarea>
    53|        </div>
    54|    </div>
    55|
    56|    <script>
    57|        let fetchTimeout;
    58|
    59|        function extractGameId(val) {
    60|            if (!val) return null;
    61|            const match = val.match(/games_id=(\d+)/) || val.match(/^(\d+)$/);
    62|            return match ? match[1] : null;
    63|        }
    64|
    65|        // Load state on startup
    66|        document.addEventListener('DOMContentLoaded', () => {
    67|            const savedId = localStorage.getItem('awbw_game_id');
    68|            const savedUser = localStorage.getItem('awbw_username');
    69|            
    70|            if (savedId) {
    71|                document.getElementById('gameId').value = savedId;
    72|                
    73|                // Extract ID just in case the saved value is a full URL
    74|                const cleanId = extractGameId(savedId);
    75|                
    76|                if (cleanId) {
    77|                    // Immediately fetch players, THEN set selection
    78|                    fetchPlayers(cleanId).then(() => {
    79|                        if (savedUser) {
    80|                            const select = document.getElementById('username');
    81|                            // Verify the saved user exists in the new list before setting
    82|                            const exists = Array.from(select.options).some(opt => opt.value === savedUser);
    83|                            if (exists) {
    84|                                select.value = savedUser;
    85|                            }
    86|                        }
    87|                    });
    88|                }
    89|            }
    90|        });
    91|
    92|        function saveState() {
    93|            const gameId = document.getElementById('gameId').value;
    94|            const username = document.getElementById('username').value;
    95|            if (gameId) localStorage.setItem('awbw_game_id', gameId);
    96|            if (username) localStorage.setItem('awbw_username', username);
    97|        }
    98|
    99|        function handleInput() {
   100|            const input = document.getElementById('gameId');
   101|            let val = input.value.trim();
   102|            
   103|            const id = extractGameId(val);
   104|            if (id) {
   105|                saveState();
   106|                clearTimeout(fetchTimeout);
   107|                fetchTimeout = setTimeout(() => fetchPlayers(id), 300);
   108|            }
   109|        }
   110|
   111|        async function fetchPlayers(gameIdInput) {
   112|            const gameId = extractGameId(String(gameIdInput));
   113|            if (!gameId) return;
   114|
   115|            const select = document.getElementById('username');
   116|            // Preserve current selection if possible during reload? No, usually wipe.
   117|            // But we might be restoring state.
   118|            const currentVal = select.value;
   119|            select.innerHTML = '<option>Loading players...</option>';
   120|            
   121|            try {
   122|                const res = await fetch(`/api/game/${gameId}/players`);
   123|                if (!res.ok) throw new Error('Failed to fetch players');
   124|                const players = await res.json();
   125|                
   126|                select.innerHTML = '<option value="">-- Spectator (Neutral) --</option>';
   127|                players.forEach(p => {
   128|                    if (p.eliminated) return; 
   129|                    
   130|                    const opt = document.createElement('option');
   131|                    opt.value = p.username;
   132|                    opt.textContent = `${p.username} (${p.co}) - Team ${p.team}`;
   133|                    select.appendChild(opt);
   134|                });
   135|                
   136|                // Restore selection if valid
   137|                if (currentVal && Array.from(select.options).some(opt => opt.value === currentVal)) {
   138|                    select.value = currentVal;
   139|                }
   140|                
   141|            } catch (err) {
   142|                console.error(err);
   143|                select.innerHTML = '<option value="">Error loading players (Check ID)</option>';
   144|            }
   145|        }
   146|
   147|        async function generateContext() {
   148|            const inputVal = document.getElementById('gameId').value;
   149|            const gameId = extractGameId(inputVal);
   150|            if (!gameId) return alert("Please enter a valid Game ID or Link");
   151|            
   152|            const username = document.getElementById('username').value;
   153|            saveState(); // Ensure save on generate
   154|            
   155|            const btn = document.getElementById('generateBtn');
   156|            const originalText = btn.textContent;
   157|            btn.disabled = true;
   158|            btn.textContent = "Generating...";
   159|            
   160|            let url = `/api/game/${gameId}/context`;
   161|            if (username) url += `?username=${encodeURIComponent(username)}`;
   162|            
   163|            try {
   164|                const res = await fetch(url);
   165|                if (!res.ok) throw new Error(await res.text());
   166|                const text = await res.text();
   167|                
   168|                document.getElementById('output').value = text;
   169|                document.getElementById('result').classList.remove('hidden');
   170|                
   171|                // Scroll to result
   172|                document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
   173|                
   174|            } catch (err) {
   175|                alert("Error: " + err.message);
   176|            } finally {
   177|                btn.disabled = false;
   178|                btn.textContent = originalText;
   179|            }
   180|        }
   181|        
   182|        function copyToClipboard() {
   183|            const copyText = document.getElementById("output");
   184|            // Select text for good measure, though writeText doesn't strictly need it if we pass value directly
   185|            copyText.select();
   186|            copyText.setSelectionRange(0, 99999); 
   187|            
   188|            navigator.clipboard.writeText(copyText.value).then(() => {
   189|                const btn = document.getElementById("copyBtn");
   190|                const originalText = "ðŸ“‹ Copy Prompt to Clipboard";
   191|                btn.textContent = "âœ… Copied!";
   192|                btn.style.background = "#059669"; // Green shade
   193|                
   194|                setTimeout(() => {
   195|                    btn.textContent = originalText;
   196|                    btn.style.background = "#10a37f"; // Original color
   197|                }, 2000);
   198|            }).catch(err => {
   199|                console.error('Failed to copy: ', err);
   200|                alert("Failed to copy automatically. Please select the text below and copy manually.");
   201|                document.getElementById('output').classList.remove('hidden');
   202|            });
   203|        }
   204|
   205|        function togglePrompt() {
   206|            const output = document.getElementById('output');
   207|            output.classList.toggle('hidden');
   208|        }
   209|    </script>
   210|</body>
   211|</html>
   212|